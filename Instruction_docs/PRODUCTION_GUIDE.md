# LocalLife ç”Ÿäº§çº§å¼€å‘ä¸éƒ¨ç½²å®Œæ•´æŒ‡å—

æœ¬æ–‡æ¡£æä¾› LocalLife é¡¹ç›®ä»å¼€å‘åˆ°ç”Ÿäº§éƒ¨ç½²çš„å®Œæ•´æŒ‡å¯¼ï¼ŒåŒ…æ‹¬æ£€æµ‹æ¸…å•ã€æœ€ä½³å®è·µã€éƒ¨ç½²æ–¹æ¡ˆå’Œè¿ç»´æŒ‡å—ã€‚

---

## ğŸ“‹ ç›®å½•

1. [ç”Ÿäº§å°±ç»ªæ€§æ£€æµ‹æ¸…å•](#1-ç”Ÿäº§å°±ç»ªæ€§æ£€æµ‹æ¸…å•)
2. [å¼€å‘ç¯å¢ƒé…ç½®](#2-å¼€å‘ç¯å¢ƒé…ç½®)
3. [ç”Ÿäº§ç¯å¢ƒæ¶æ„è®¾è®¡](#3-ç”Ÿäº§ç¯å¢ƒæ¶æ„è®¾è®¡)
4. [æ•°æ®åº“é›†æˆ](#4-æ•°æ®åº“é›†æˆ)
5. [è®¤è¯ä¸æˆæƒ](#5-è®¤è¯ä¸æˆæƒ)
6. [å®‰å…¨åŠ å›º](#6-å®‰å…¨åŠ å›º)
7. [æ€§èƒ½ä¼˜åŒ–](#7-æ€§èƒ½ä¼˜åŒ–)
8. [ç›‘æ§ä¸æ—¥å¿—](#8-ç›‘æ§ä¸æ—¥å¿—)
9. [æµ‹è¯•ç­–ç•¥](#9-æµ‹è¯•ç­–ç•¥)
10. [CI/CD é…ç½®](#10-cicd-é…ç½®)
11. [éƒ¨ç½²æ–¹æ¡ˆ](#11-éƒ¨ç½²æ–¹æ¡ˆ)
12. [è¿ç»´æŒ‡å—](#12-è¿ç»´æŒ‡å—)

---

## 1. ç”Ÿäº§å°±ç»ªæ€§æ£€æµ‹æ¸…å•

### 1.1 åŸºç¡€è®¾æ–½ âœ…/âŒ

- [ ] **æ•°æ®åº“**: PostgreSQL + PostGIS å·²é…ç½®
- [ ] **ç¼“å­˜**: Redis å·²é…ç½®å¹¶è¿è¡Œ
- [ ] **æ¶ˆæ¯é˜Ÿåˆ—**: RabbitMQ/Kafkaï¼ˆå¯é€‰ï¼Œç”¨äºå¼‚æ­¥ä»»åŠ¡ï¼‰
- [ ] **å¯¹è±¡å­˜å‚¨**: AWS S3/Cloudflare R2ï¼ˆç”¨äºå›¾ç‰‡å­˜å‚¨ï¼‰
- [ ] **CDN**: Cloudflare/AWS CloudFrontï¼ˆé™æ€èµ„æºåŠ é€Ÿï¼‰

### 1.2 å®‰å…¨ âœ…/âŒ

- [ ] **API Key ä¿æŠ¤**: æ‰€æœ‰æ•æ„Ÿå¯†é’¥å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡/å¯†é’¥ç®¡ç†æœåŠ¡
- [ ] **HTTPS**: ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ä½¿ç”¨ HTTPS
- [ ] **CORS**: æ­£ç¡®é…ç½®å…è®¸çš„æ¥æº
- [ ] **è®¤è¯**: SIWE è®¤è¯å·²å®ç°
- [ ] **æˆæƒ**: åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
- [ ] **è¾“å…¥éªŒè¯**: æ‰€æœ‰ API ç«¯ç‚¹ä½¿ç”¨ Zod éªŒè¯
- [ ] **é€Ÿç‡é™åˆ¶**: API é€Ÿç‡é™åˆ¶å·²é…ç½®
- [ ] **SQL æ³¨å…¥é˜²æŠ¤**: ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆPrismaï¼‰
- [ ] **XSS é˜²æŠ¤**: å‰ç«¯è¾“å…¥è½¬ä¹‰
- [ ] **CSRF é˜²æŠ¤**: CSRF Token éªŒè¯

### 1.3 æ•°æ®æŒä¹…åŒ– âœ…/âŒ

- [ ] **æ•°æ®åº“è¿ç§»**: Prisma è¿ç§»è„šæœ¬å·²é…ç½®
- [ ] **æ•°æ®å¤‡ä»½**: è‡ªåŠ¨å¤‡ä»½ç­–ç•¥å·²å®æ–½
- [ ] **æ•°æ®æ¢å¤**: æ¢å¤æµç¨‹å·²æµ‹è¯•
- [ ] **è¿æ¥æ± **: æ•°æ®åº“è¿æ¥æ± å·²é…ç½®
- [ ] **è¯»å†™åˆ†ç¦»**: ï¼ˆå¯é€‰ï¼‰ä¸»ä»æ•°æ®åº“é…ç½®

### 1.4 å¯è§‚æµ‹æ€§ âœ…/âŒ

- [ ] **æ—¥å¿—**: ç»“æ„åŒ–æ—¥å¿—ï¼ˆWinston/Pinoï¼‰
- [ ] **ç›‘æ§**: Prometheus + Grafana
- [ ] **å‘Šè­¦**: å…³é”®æŒ‡æ ‡å‘Šè­¦è§„åˆ™
- [ ] **è¿½è¸ª**: OpenTelemetry/Jaegerï¼ˆåˆ†å¸ƒå¼è¿½è¸ªï¼‰
- [ ] **å¥åº·æ£€æŸ¥**: `/health` å’Œ `/ready` ç«¯ç‚¹

### 1.5 æ€§èƒ½ âœ…/âŒ

- [ ] **ç¼“å­˜ç­–ç•¥**: Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®
- [ ] **CDN**: é™æ€èµ„æºé€šè¿‡ CDN åˆ†å‘
- [ ] **å‹ç¼©**: Gzip/Brotli å‹ç¼©å·²å¯ç”¨
- [ ] **æ•°æ®åº“ç´¢å¼•**: å…³é”®æŸ¥è¯¢å­—æ®µå·²å»ºç«‹ç´¢å¼•
- [ ] **åˆ†é¡µ**: æ‰€æœ‰åˆ—è¡¨æ¥å£æ”¯æŒåˆ†é¡µ
- [ ] **é™æµ**: API é™æµå·²é…ç½®

### 1.6 æµ‹è¯• âœ…/âŒ

- [ ] **å•å…ƒæµ‹è¯•**: è¦†ç›–ç‡ > 80%
- [ ] **é›†æˆæµ‹è¯•**: API ç«¯ç‚¹æµ‹è¯•
- [ ] **E2E æµ‹è¯•**: å…³é”®ç”¨æˆ·æµç¨‹æµ‹è¯•
- [ ] **è´Ÿè½½æµ‹è¯•**: å‹åŠ›æµ‹è¯•å·²æ‰§è¡Œ
- [ ] **å®‰å…¨æµ‹è¯•**: OWASP Top 10 æ£€æŸ¥

### 1.7 CI/CD âœ…/âŒ

- [ ] **è‡ªåŠ¨åŒ–æµ‹è¯•**: PR è‡ªåŠ¨è¿è¡Œæµ‹è¯•
- [ ] **ä»£ç è´¨é‡**: ESLint/Prettier æ£€æŸ¥
- [ ] **å®‰å…¨æ‰«æ**: ä¾èµ–æ¼æ´æ‰«æ
- [ ] **è‡ªåŠ¨åŒ–éƒ¨ç½²**: éƒ¨ç½²æµç¨‹å·²è‡ªåŠ¨åŒ–
- [ ] **å›æ»šæœºåˆ¶**: å¿«é€Ÿå›æ»šæµç¨‹

### 1.8 æ–‡æ¡£ âœ…/âŒ

- [ ] **API æ–‡æ¡£**: OpenAPI/Swagger æ–‡æ¡£
- [ ] **éƒ¨ç½²æ–‡æ¡£**: éƒ¨ç½²æ­¥éª¤å·²æ–‡æ¡£åŒ–
- [ ] **è¿ç»´æ‰‹å†Œ**: æ•…éšœæ’æŸ¥æŒ‡å—
- [ ] **æ¶æ„å›¾**: ç³»ç»Ÿæ¶æ„å›¾å·²æ›´æ–°

---

## 2. å¼€å‘ç¯å¢ƒé…ç½®

### 2.1 å¼€å‘å·¥å…·é“¾

```bash
# æ¨èå·¥å…·
- Node.js 20+ (LTS)
- pnpm (æ¨è) æˆ– npm
- Docker & Docker Compose
- VS Code + æ¨èæ‰©å±•
  - ESLint
  - Prettier
  - Prisma
  - TypeScript
```

### 2.2 æœ¬åœ°å¼€å‘ç¯å¢ƒ

ä½¿ç”¨ Docker Compose å¿«é€Ÿå¯åŠ¨å¼€å‘ç¯å¢ƒï¼š

```yaml
# docker-compose.dev.yml
version: '3.8'
services:
  postgres:
    image: postgis/postgis:16-3.4
    environment:
      POSTGRES_USER: locallife
      POSTGRES_PASSWORD: dev_password
      POSTGRES_DB: locallife_dev
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

å¯åŠ¨å‘½ä»¤ï¼š
```bash
docker-compose -f docker-compose.dev.yml up -d
```

### 2.3 ç¯å¢ƒå˜é‡ç®¡ç†

**å¼€å‘ç¯å¢ƒ** (`.env.development`):
```env
# Backend
NODE_ENV=development
PORT=3001
FRONTEND_URL=http://localhost:3000

# Database
DATABASE_URL=postgresql://locallife:dev_password@localhost:5432/locallife_dev

# Redis
REDIS_URL=redis://localhost:6379

# Gemini API
GEMINI_API_KEY=your_dev_api_key

# JWT
JWT_SECRET=dev_jwt_secret_change_in_production
JWT_EXPIRES_IN=7d

# CORS
CORS_ORIGIN=http://localhost:3000
```

**ç”Ÿäº§ç¯å¢ƒ** (ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡):
- AWS Secrets Manager
- HashiCorp Vault
- Azure Key Vault
- Google Secret Manager

---

## 3. ç”Ÿäº§ç¯å¢ƒæ¶æ„è®¾è®¡

### 3.1 æ¨èæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CDN (Cloudflare)                     â”‚
â”‚              (Static Assets + DDoS Protection)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Load Balancer (Nginx/ALB)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend       â”‚          â”‚   Backend API      â”‚
â”‚  (Vercel/Netlifyâ”‚          â”‚  (Node.js Cluster) â”‚
â”‚   / S3+CF)      â”‚          â”‚                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚               â”‚               â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
            â”‚ PostgreSQL â”‚  â”‚   Redis    â”‚  â”‚  S3/R2     â”‚
            â”‚  (RDS)     â”‚  â”‚ (ElastiCacheâ”‚  â”‚ (Storage)  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 é«˜å¯ç”¨é…ç½®

- **å‰ç«¯**: CDN + å¤šåŒºåŸŸéƒ¨ç½²
- **åç«¯**: å¤šå®ä¾‹ + è´Ÿè½½å‡è¡¡
- **æ•°æ®åº“**: ä¸»ä»å¤åˆ¶ + è‡ªåŠ¨æ•…éšœè½¬ç§»
- **ç¼“å­˜**: Redis é›†ç¾¤æ¨¡å¼

### 3.3 æ‰©å±•æ€§è€ƒè™‘

- **æ°´å¹³æ‰©å±•**: æ— çŠ¶æ€ API æœåŠ¡ï¼Œæ˜“äºæ‰©å±•
- **æ•°æ®åº“åˆ†ç‰‡**: ï¼ˆæœªæ¥ï¼‰æŒ‰åœ°ç†ä½ç½®åˆ†ç‰‡
- **ç¼“å­˜åˆ†å±‚**: L1 (å†…å­˜) + L2 (Redis) + L3 (æ•°æ®åº“)

---

## 4. æ•°æ®åº“é›†æˆ

### 4.1 Prisma é…ç½®

```bash
# å®‰è£… Prisma
cd server
npm install prisma @prisma/client
npx prisma init
```

**Prisma Schema** (`server/prisma/schema.prisma`):

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  walletAddress String    @unique
  role          UserRole  @default(BUYER)
  reputation    Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  services      Service[]
  demands       Demand[]
  ordersAsBuyer Order[]   @relation("BuyerOrders")
  ordersAsSeller Order[]   @relation("SellerOrders")
}

model Service {
  id            String   @id @default(cuid())
  sellerId      String
  seller        User     @relation(fields: [sellerId], references: [id])
  title         String
  description   String
  category      String
  location      String
  price         Decimal  @db.Decimal(10, 2)
  unit          String
  tokenAddress  String?  @unique
  supply        Int?
  imageUrl      String?
  avatarUrl     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  orders        Order[]
  
  @@index([category])
  @@index([location])
  @@index([sellerId])
}

model Demand {
  id          String   @id @default(cuid())
  buyerId     String
  buyer       User     @relation(fields: [buyerId], references: [id])
  title       String
  description String
  category    String
  location    String
  budget      Decimal  @db.Decimal(10, 2)
  expiry      DateTime?
  avatarUrl   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
  @@index([location])
  @@index([buyerId])
}

model Order {
  id            String      @id @default(cuid())
  serviceId     String
  service       Service     @relation(fields: [serviceId], references: [id])
  buyerId       String
  buyer         User        @relation("BuyerOrders", fields: [buyerId], references: [id])
  sellerId      String
  seller        User        @relation("SellerOrders", fields: [sellerId], references: [id])
  amount        Decimal     @db.Decimal(10, 2)
  status        OrderStatus @default(CREATED)
  txHash        String?
  escrowAddress String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
}

enum UserRole {
  BUYER
  SELLER
}

enum OrderStatus {
  CREATED
  MATCHED
  ACCEPTED
  PAID
  IN_SERVICE
  COMPLETED
  SETTLED
  REFUNDED
}
```

### 4.2 æ•°æ®åº“è¿ç§»

```bash
# åˆ›å»ºè¿ç§»
npx prisma migrate dev --name init

# ç”Ÿäº§ç¯å¢ƒè¿ç§»
npx prisma migrate deploy

# ç”Ÿæˆ Prisma Client
npx prisma generate
```

### 4.3 åœ°ç†ç©ºé—´æŸ¥è¯¢ï¼ˆPostGISï¼‰

```sql
-- å¯ç”¨ PostGIS æ‰©å±•
CREATE EXTENSION IF NOT EXISTS postgis;

-- æ·»åŠ åœ°ç†ä½ç½®å­—æ®µ
ALTER TABLE services ADD COLUMN location_point geometry(Point, 4326);
CREATE INDEX location_point_idx ON services USING GIST (location_point);
```

### 4.4 è¿æ¥æ± é…ç½®

```typescript
// server/src/config/database.ts
import { PrismaClient } from '@prisma/client';

export const prisma = new PrismaClient({
  log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
  datasources: {
    db: {
      url: process.env.DATABASE_URL,
    },
  },
});

// è¿æ¥æ± é…ç½®ï¼ˆåœ¨ DATABASE_URL ä¸­ï¼‰
// postgresql://user:password@host:5432/db?connection_limit=10&pool_timeout=20
```

---

## 5. è®¤è¯ä¸æˆæƒ

### 5.1 SIWE å®ç°

```typescript
// server/src/services/authService.ts
import { ethers } from 'ethers';
import jwt from 'jsonwebtoken';

export interface SiweMessage {
  domain: string;
  address: string;
  statement: string;
  uri: string;
  version: string;
  chainId: number;
  nonce: string;
  issuedAt: string;
}

export class AuthService {
  async generateNonce(): Promise<string> {
    return crypto.randomBytes(16).toString('hex');
  }

  async verifySiwe(message: SiweMessage, signature: string): Promise<boolean> {
    try {
      const recoveredAddress = ethers.verifyMessage(
        this.formatMessage(message),
        signature
      );
      return recoveredAddress.toLowerCase() === message.address.toLowerCase();
    } catch {
      return false;
    }
  }

  generateToken(address: string): string {
    return jwt.sign(
      { address, type: 'siwe' },
      process.env.JWT_SECRET!,
      { expiresIn: process.env.JWT_EXPIRES_IN || '7d' }
    );
  }

  private formatMessage(message: SiweMessage): string {
    return `${message.domain} wants you to sign in with your Ethereum account:\n${message.address}\n\n${message.statement}\n\nURI: ${message.uri}\nVersion: ${message.version}\nChain ID: ${message.chainId}\nNonce: ${message.nonce}\nIssued At: ${message.issuedAt}`;
  }
}
```

### 5.2 JWT ä¸­é—´ä»¶

```typescript
// server/src/middleware/auth.ts
import { Request, Response, NextFunction } from 'express';
import jwt from 'jsonwebtoken';

export interface AuthRequest extends Request {
  user?: {
    address: string;
    type: string;
  };
}

export const authenticate = (
  req: AuthRequest,
  res: Response,
  next: NextFunction
) => {
  const token = req.headers.authorization?.replace('Bearer ', '');

  if (!token) {
    return res.status(401).json({
      success: false,
      error: 'UNAUTHORIZED',
      message: 'No token provided'
    });
  }

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET!) as any;
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({
      success: false,
      error: 'UNAUTHORIZED',
      message: 'Invalid token'
    });
  }
};
```

### 5.3 æˆæƒä¸­é—´ä»¶

```typescript
// server/src/middleware/authorize.ts
import { Response, NextFunction } from 'express';
import { AuthRequest } from './auth';

export const requireRole = (...roles: string[]) => {
  return (req: AuthRequest, res: Response, next: NextFunction) => {
    if (!req.user) {
      return res.status(401).json({
        success: false,
        error: 'UNAUTHORIZED',
        message: 'Authentication required'
      });
    }

    // ä»æ•°æ®åº“è·å–ç”¨æˆ·è§’è‰²
    // const user = await prisma.user.findUnique({ where: { walletAddress: req.user.address } });
    // if (!roles.includes(user.role)) {
    //   return res.status(403).json({ ... });
    // }

    next();
  };
};
```

---

## 6. å®‰å…¨åŠ å›º

### 6.1 é€Ÿç‡é™åˆ¶

```typescript
// server/src/middleware/rateLimit.ts
import rateLimit from 'express-rate-limit';

export const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // limit each IP to 100 requests per windowMs
  message: 'Too many requests from this IP, please try again later.',
  standardHeaders: true,
  legacyHeaders: false,
});

export const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5, // limit each IP to 5 requests per windowMs
  skipSuccessfulRequests: true,
});
```

### 6.2 å®‰å…¨å¤´

```typescript
// server/src/middleware/security.ts
import helmet from 'helmet';

export const securityMiddleware = helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", 'data:', 'https:'],
    },
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true,
  },
});
```

### 6.3 è¾“å…¥æ¸…ç†

```typescript
// server/src/middleware/sanitize.ts
import { z } from 'zod';

export const sanitizeInput = (schema: z.ZodSchema) => {
  return (req: Request, res: Response, next: NextFunction) => {
    try {
      req.body = schema.parse(req.body);
      next();
    } catch (error) {
      if (error instanceof z.ZodError) {
        return res.status(422).json({
          success: false,
          error: 'VALIDATION_ERROR',
          message: 'Invalid input',
          details: error.errors,
        });
      }
      next(error);
    }
  };
};
```

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 Redis ç¼“å­˜

```typescript
// server/src/services/cacheService.ts
import Redis from 'ioredis';

const redis = new Redis(process.env.REDIS_URL!);

export class CacheService {
  async get<T>(key: string): Promise<T | null> {
    const value = await redis.get(key);
    return value ? JSON.parse(value) : null;
  }

  async set(key: string, value: any, ttl: number = 3600): Promise<void> {
    await redis.setex(key, ttl, JSON.stringify(value));
  }

  async del(key: string): Promise<void> {
    await redis.del(key);
  }

  async getOrSet<T>(
    key: string,
    fetcher: () => Promise<T>,
    ttl: number = 3600
  ): Promise<T> {
    const cached = await this.get<T>(key);
    if (cached) return cached;

    const fresh = await fetcher();
    await this.set(key, fresh, ttl);
    return fresh;
  }
}
```

### 7.2 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

```typescript
// ä½¿ç”¨ Prisma æŸ¥è¯¢ä¼˜åŒ–
const services = await prisma.service.findMany({
  where: {
    category: 'Culinary',
    // ä½¿ç”¨ç´¢å¼•å­—æ®µ
  },
  take: 20, // åˆ†é¡µ
  skip: 0,
  orderBy: {
    createdAt: 'desc',
  },
  select: {
    // åªé€‰æ‹©éœ€è¦çš„å­—æ®µ
    id: true,
    title: true,
    price: true,
    // ...
  },
});
```

### 7.3 CDN é…ç½®

```nginx
# nginx.conf
server {
    listen 80;
    server_name api.locallife.io;

    # Gzip å‹ç¼©
    gzip on;
    gzip_types text/plain text/css application/json application/javascript;

    # é™æ€èµ„æºç¼“å­˜
    location /static/ {
        alias /var/www/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API ä»£ç†
    location /api/ {
        proxy_pass http://backend:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## 8. ç›‘æ§ä¸æ—¥å¿—

### 8.1 ç»“æ„åŒ–æ—¥å¿—

```typescript
// server/src/utils/logger.ts
import winston from 'winston';

export const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
  ],
});

if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple(),
  }));
}
```

### 8.2 Prometheus æŒ‡æ ‡

```typescript
// server/src/middleware/metrics.ts
import client from 'prom-client';

const register = new client.Registry();

// æ”¶é›†é»˜è®¤æŒ‡æ ‡
client.collectDefaultMetrics({ register });

// è‡ªå®šä¹‰æŒ‡æ ‡
const httpRequestDuration = new client.Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'status'],
  registers: [register],
});

export const metricsMiddleware = (req: Request, res: Response, next: NextFunction) => {
  const start = Date.now();

  res.on('finish', () => {
    const duration = (Date.now() - start) / 1000;
    httpRequestDuration.observe(
      {
        method: req.method,
        route: req.route?.path || req.path,
        status: res.statusCode,
      },
      duration
    );
  });

  next();
};

// æŒ‡æ ‡ç«¯ç‚¹
export const metricsRoute = async (req: Request, res: Response) => {
  res.set('Content-Type', register.contentType);
  res.end(await register.metrics());
};
```

### 8.3 å¥åº·æ£€æŸ¥

```typescript
// server/src/routes/health.ts
export const healthRouter = Router();

healthRouter.get('/health', (req, res) => {
  res.json({ status: 'ok', timestamp: Date.now() });
});

healthRouter.get('/ready', async (req, res) => {
  try {
    // æ£€æŸ¥æ•°æ®åº“è¿æ¥
    await prisma.$queryRaw`SELECT 1`;
    // æ£€æŸ¥ Redis è¿æ¥
    await redis.ping();
    
    res.json({ status: 'ready' });
  } catch (error) {
    res.status(503).json({ status: 'not ready', error: error.message });
  }
});
```

---

## 9. æµ‹è¯•ç­–ç•¥

### 9.1 å•å…ƒæµ‹è¯•

```typescript
// server/src/services/__tests__/authService.test.ts
import { describe, it, expect } from 'vitest';
import { AuthService } from '../authService';

describe('AuthService', () => {
  it('should generate nonce', () => {
    const service = new AuthService();
    const nonce = service.generateNonce();
    expect(nonce).toHaveLength(32);
  });
});
```

### 9.2 é›†æˆæµ‹è¯•

```typescript
// server/src/routes/__tests__/services.test.ts
import { describe, it, expect } from 'vitest';
import request from 'supertest';
import app from '../../index';

describe('POST /api/v1/services', () => {
  it('should create a service', async () => {
    const response = await request(app)
      .post('/api/v1/services')
      .send({
        title: 'Test Service',
        description: 'Test',
        category: 'Digital',
        location: 'Remote',
        price: 100,
        unit: 'USDC/hr',
        sellerId: '0x123',
      });

    expect(response.status).toBe(201);
    expect(response.body.success).toBe(true);
  });
});
```

### 9.3 E2E æµ‹è¯•

```typescript
// e2e/agent-flow.test.ts
import { test, expect } from '@playwright/test';

test('agent should create service from conversation', async ({ page }) => {
  await page.goto('http://localhost:3000');
  
  // æ‰“å¼€èŠå¤©çª—å£
  await page.click('[aria-label="Toggle AI Agent"]');
  
  // å‘é€æ¶ˆæ¯
  await page.fill('input[type="text"]', 'I want to offer Thai cooking classes');
  await page.press('input[type="text"]', 'Enter');
  
  // ç­‰å¾…å“åº”
  await page.waitForSelector('.message-assistant', { timeout: 10000 });
  
  // éªŒè¯æœåŠ¡å·²åˆ›å»º
  await expect(page.locator('.service-card')).toContainText('Thai cooking');
});
```

---

## 10. CI/CD é…ç½®

### 10.1 GitHub Actions

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint
      
      - name: Run tests
        run: npm run test
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379
      
      - name: Build
        run: npm run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to production
        run: |
          # éƒ¨ç½²è„šæœ¬
          echo "Deploying to production..."
```

### 10.2 Docker é•œåƒæ„å»º

```dockerfile
# server/Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM node:20-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY --from=builder /app/dist ./dist
COPY --from=builder /app/prisma ./prisma

RUN npx prisma generate

EXPOSE 3001

CMD ["node", "dist/index.js"]
```

---

## 11. éƒ¨ç½²æ–¹æ¡ˆ

### 11.1 Vercel/Netlify (å‰ç«¯)

```bash
# å®‰è£… Vercel CLI
npm i -g vercel

# éƒ¨ç½²
vercel --prod
```

**é…ç½®** (`vercel.json`):
```json
{
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "env": {
    "VITE_API_BASE_URL": "https://api.locallife.io"
  }
}
```

### 11.2 Railway/Render (åç«¯)

**Railway**:
1. è¿æ¥ GitHub ä»“åº“
2. è®¾ç½®ç¯å¢ƒå˜é‡
3. è‡ªåŠ¨éƒ¨ç½²

**Render**:
```yaml
# render.yaml
services:
  - type: web
    name: locallife-api
    env: node
    buildCommand: cd server && npm install && npm run build
    startCommand: cd server && npm start
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: locallife-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: locallife-redis
          type: redis
          property: connectionString
```

### 11.3 AWS ECS/Fargate

```yaml
# docker-compose.prod.yml
version: '3.8'
services:
  backend:
    build: ./server
    ports:
      - "3001:3001"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    deploy:
      replicas: 3
      update_config:
        parallelism: 1
        delay: 10s
```

### 11.4 Kubernetes

```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: locallife-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: locallife-api
  template:
    metadata:
      labels:
        app: locallife-api
    spec:
      containers:
      - name: api
        image: locallife/api:latest
        ports:
        - containerPort: 3001
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: locallife-secrets
              key: database-url
```

---

## 12. è¿ç»´æŒ‡å—

### 12.1 æ•°æ®åº“å¤‡ä»½

```bash
# æ¯æ—¥å¤‡ä»½è„šæœ¬
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
pg_dump $DATABASE_URL > backup_$DATE.sql
aws s3 cp backup_$DATE.sql s3://locallife-backups/
```

### 12.2 æ—¥å¿—è½®è½¬

```yaml
# logrotate.conf
/var/log/locallife/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 app app
}
```

### 12.3 æ•…éšœæ’æŸ¥

**å¸¸è§é—®é¢˜**:

1. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   - æ£€æŸ¥è¿æ¥æ± é…ç½®
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—

2. **Redis è¿æ¥è¶…æ—¶**
   - æ£€æŸ¥ Redis æœåŠ¡çŠ¶æ€
   - æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ
   - å¢åŠ è¿æ¥è¶…æ—¶æ—¶é—´

3. **API å“åº”æ…¢**
   - æ£€æŸ¥æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
   - æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
   - æ£€æŸ¥å¤–éƒ¨ API è°ƒç”¨

### 12.4 æ€§èƒ½è°ƒä¼˜

```typescript
// æ•°æ®åº“è¿æ¥æ± è°ƒä¼˜
DATABASE_URL=postgresql://...?connection_limit=20&pool_timeout=20

// Node.js æ€§èƒ½
NODE_OPTIONS=--max-old-space-size=4096
```

---

## ğŸ“š é™„å½•

### A. ç¯å¢ƒå˜é‡æ¸…å•

**å¿…éœ€**:
- `DATABASE_URL`
- `REDIS_URL`
- `GEMINI_API_KEY`
- `JWT_SECRET`

**å¯é€‰**:
- `LOG_LEVEL`
- `CORS_ORIGIN`
- `PORT`

### B. ç›‘æ§æŒ‡æ ‡

- API å“åº”æ—¶é—´
- é”™è¯¯ç‡
- æ•°æ®åº“è¿æ¥æ•°
- Redis å†…å­˜ä½¿ç”¨
- è¯·æ±‚ QPS

### C. å‘Šè­¦è§„åˆ™

- é”™è¯¯ç‡ > 5%
- å“åº”æ—¶é—´ > 1s
- æ•°æ®åº“è¿æ¥æ•° > 80%
- å†…å­˜ä½¿ç”¨ > 90%

---

*æœ€åæ›´æ–°: 2026å¹´*  
*æ–‡æ¡£ç‰ˆæœ¬: 1.0*
