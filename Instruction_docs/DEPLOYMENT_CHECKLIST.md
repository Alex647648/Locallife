# LocalLife 部署检查清单

本文档提供部署前的完整检查清单，确保生产环境部署成功。

---

## 📋 部署前检查

### 1. 代码准备 ✅/❌

- [ ] 所有代码已合并到 `main` 分支
- [ ] 代码已通过所有测试（单元测试、集成测试、E2E 测试）
- [ ] 代码已通过 ESLint 和 TypeScript 类型检查
- [ ] 无已知的严重 Bug
- [ ] 代码审查已完成并批准

### 2. 环境变量配置 ✅/❌

**后端环境变量**:
- [ ] `DATABASE_URL` - 数据库连接字符串
- [ ] `REDIS_URL` - Redis 连接字符串
- [ ] `GEMINI_API_KEY` - Gemini API 密钥
- [ ] `JWT_SECRET` - JWT 签名密钥（强随机字符串）
- [ ] `JWT_EXPIRES_IN` - Token 过期时间
- [ ] `CORS_ORIGIN` - 允许的前端域名
- [ ] `NODE_ENV=production`
- [ ] `PORT` - 服务端口（默认 3001）
- [ ] `LOG_LEVEL` - 日志级别（info/warn/error）

**前端环境变量**:
- [ ] `VITE_API_BASE_URL` - 后端 API 地址
- [ ] 其他必要的环境变量

**密钥管理**:
- [ ] 所有敏感信息存储在密钥管理服务（AWS Secrets Manager/HashiCorp Vault）
- [ ] 生产环境不使用 `.env` 文件
- [ ] API Key 已轮换（如果适用）

### 3. 数据库准备 ✅/❌

- [ ] 数据库已创建（PostgreSQL + PostGIS）
- [ ] 数据库迁移脚本已准备
- [ ] 迁移脚本已测试
- [ ] 数据库备份策略已配置
- [ ] 数据库连接池配置已优化
- [ ] 数据库索引已创建
- [ ] 数据库用户权限已配置（最小权限原则）

**迁移命令**:
```bash
cd server
npx prisma migrate deploy
npx prisma generate
```

### 4. Redis 准备 ✅/❌

- [ ] Redis 实例已创建
- [ ] Redis 连接配置正确
- [ ] Redis 持久化已配置（如果需要）
- [ ] Redis 内存限制已设置
- [ ] Redis 密码已配置（如果使用）

### 5. 基础设施 ✅/❌

**服务器/容器**:
- [ ] 服务器资源充足（CPU、内存、磁盘）
- [ ] 服务器安全组/防火墙规则已配置
- [ ] SSL 证书已配置（HTTPS）
- [ ] 域名 DNS 记录已配置
- [ ] CDN 已配置（如果使用）

**负载均衡**:
- [ ] 负载均衡器已配置
- [ ] 健康检查端点已配置
- [ ] 会话粘性配置（如果需要）

**监控**:
- [ ] 监控系统已配置（Prometheus/Grafana）
- [ ] 告警规则已配置
- [ ] 日志收集已配置
- [ ] 错误追踪已配置（Sentry）

### 6. 安全配置 ✅/❌

- [ ] HTTPS 已启用并强制重定向
- [ ] CORS 配置正确（仅允许生产域名）
- [ ] API 速率限制已配置
- [ ] 安全头已配置（Helmet）
- [ ] SQL 注入防护（使用 Prisma）
- [ ] XSS 防护
- [ ] CSRF 防护（如果适用）
- [ ] 依赖漏洞扫描通过
- [ ] 安全审计已完成

### 7. 性能优化 ✅/❌

- [ ] 前端代码已构建和优化
- [ ] 静态资源已压缩（Gzip/Brotli）
- [ ] 图片已优化
- [ ] CDN 已配置
- [ ] 数据库查询已优化
- [ ] 缓存策略已配置
- [ ] API 响应时间 < 500ms（P95）

### 8. 测试验证 ✅/❌

- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试已通过
- [ ] E2E 测试已通过
- [ ] 负载测试已执行
- [ ] 安全测试已执行
- [ ] 浏览器兼容性测试已通过

### 9. 文档 ✅/❌

- [ ] API 文档已更新
- [ ] 部署文档已更新
- [ ] 运维手册已准备
- [ ] 故障排查指南已准备
- [ ] 回滚流程已文档化

### 10. 备份和恢复 ✅/❌

- [ ] 数据库备份策略已配置
- [ ] 备份恢复流程已测试
- [ ] 代码版本控制（Git）
- [ ] 配置文件版本控制
- [ ] 回滚计划已准备

---

## 🚀 部署步骤

### 步骤 1: 预部署检查

```bash
# 运行生产就绪性检测
./scripts/check-production-ready.sh

# 检查环境变量
echo $DATABASE_URL
echo $REDIS_URL
echo $GEMINI_API_KEY

# 检查构建
npm run build
cd server && npm run build
```

### 步骤 2: 数据库迁移

```bash
cd server
npx prisma migrate deploy
npx prisma generate
```

### 步骤 3: 部署后端

```bash
# 构建 Docker 镜像（如果使用）
docker build -t locallife-api:latest ./server

# 部署到服务器
# （根据你的部署平台执行相应命令）
```

### 步骤 4: 部署前端

```bash
# 构建前端
npm run build

# 部署到 CDN/静态托管
# （根据你的部署平台执行相应命令）
```

### 步骤 5: 健康检查

```bash
# 检查后端健康
curl https://api.locallife.io/health

# 检查前端
curl https://locallife.io
```

### 步骤 6: 功能验证

- [ ] 用户注册/登录功能正常
- [ ] 服务创建功能正常
- [ ] 需求发布功能正常
- [ ] AI 对话功能正常
- [ ] 订单创建功能正常
- [ ] 支付流程正常（如果已实现）

---

## 🔍 部署后验证

### 1. 功能验证 ✅/❌

- [ ] 所有核心功能正常工作
- [ ] API 响应正常
- [ ] 数据库操作正常
- [ ] 缓存工作正常
- [ ] AI 服务正常

### 2. 性能验证 ✅/❌

- [ ] API 响应时间正常（< 500ms P95）
- [ ] 页面加载时间正常（< 3s）
- [ ] 数据库查询性能正常
- [ ] 内存使用正常
- [ ] CPU 使用正常

### 3. 监控验证 ✅/❌

- [ ] 日志正常记录
- [ ] 指标正常收集
- [ ] 告警规则正常工作
- [ ] 错误追踪正常工作

### 4. 安全验证 ✅/❌

- [ ] HTTPS 正常工作
- [ ] CORS 配置正确
- [ ] 速率限制正常工作
- [ ] 认证授权正常工作

---

## 🚨 回滚计划

### 回滚触发条件

- 严重 Bug 导致服务不可用
- 性能严重下降
- 安全漏洞被发现
- 数据丢失或损坏

### 回滚步骤

1. **停止新版本部署**
   ```bash
   # 停止当前服务
   ```

2. **恢复数据库**（如果需要）
   ```bash
   # 从备份恢复数据库
   ```

3. **回滚代码**
   ```bash
   git checkout <previous-stable-tag>
   ```

4. **重新部署**
   ```bash
   # 部署上一个稳定版本
   ```

5. **验证回滚**
   - 检查服务是否正常
   - 检查功能是否正常
   - 检查数据完整性

---

## 📊 部署后监控

### 关键指标

- **可用性**: > 99.9%
- **响应时间**: P95 < 500ms
- **错误率**: < 0.1%
- **数据库连接**: < 80% 使用率
- **内存使用**: < 80%
- **CPU 使用**: < 70%

### 告警规则

- 错误率 > 1%
- 响应时间 > 1s
- 可用性 < 99%
- 数据库连接 > 90%
- 内存使用 > 90%

---

## 📝 部署记录

### 部署信息

- **部署时间**: _______________
- **部署版本**: _______________
- **部署人员**: _______________
- **部署环境**: _______________

### 变更内容

- 新增功能: _______________
- Bug 修复: _______________
- 性能优化: _______________
- 安全更新: _______________

### 已知问题

- _______________
- _______________

### 后续行动

- [ ] _______________
- [ ] _______________

---

*最后更新: 2026年*
